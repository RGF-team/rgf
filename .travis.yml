sudo: false

# Travis CI does not currently support Python on Mac OS X
language: generic

os:
  - linux
  - osx

env:
  - PYTHON_VERSION=2.7
  - PYTHON_VERSION=3.4
  - PYTHON_VERSION=3.5
  - PYTHON_VERSION=3.6

git:
  submodules: true

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew install gcc;
      brew link --overwrite gcc;
      export CXX=g++-7 && export CC=gcc-7;
      curl https://repo.continuum.io/miniconda/Miniconda${PYTHON_VERSION:0:1}-latest-MacOSX-x86_64.sh -o miniconda.sh;
    else
      sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test;
      sudo apt-get update;
      sudo apt-get install g++-5;
      export CXX=g++-5 && export CC=gcc-5;
      wget https://repo.continuum.io/miniconda/Miniconda${PYTHON_VERSION:0:1}-latest-Linux-x86_64.sh -O miniconda.sh;
    fi

  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda

  - conda create -q -n test-environment python=$PYTHON_VERSION
  - source activate test-environment

  - RGF_VER=$(head -n 1 rgf/VERSION)

install:
  - conda install -q numpy scipy nose pandas scikit-learn
  - pip install pytest>=3.3
  - python setup.py sdist --formats gztar
  - pip install dist/rgf_python-$RGF_VER.tar.gz -v

# Temp solution for testing FastRGF
  - cd include/fast_rgf/build
  - cmake ..
  - make
  - make install
  - cp ../bin/forest_train ../bin/forest_predict ~/
  - cd ../../..

script:
  - pytest tests/ -o "python_files=*.py" -v
  - pip uninstall -y rgf_python
  - python setup.py install
  - pytest tests/ -o "python_files=*.py" -v

before_deploy:
  - if [[ $TRAVIS_OS_NAME == "osx" ]]; then
      python setup.py bdist_wheel --plat-name=any --universal;
      mv dist/rgf_python-${RGF_VER}-py2.py3-none-any.whl dist/rgf_python-${RGF_VER}-py2.py3-none-macosx_10_6_x86_64.macosx_10_7_x86_64.macosx_10_8_x86_64.macosx_10_9_x86_64.macosx_10_10_x86_64.macosx_10_11_x86_64.macosx_10_12_x86_64.macosx_10_13_x86_64.whl;
    else
      python setup.py bdist_wheel --plat-name=manylinux1_x86_64 --universal;
      python setup.py bdist_wheel --plat-name=manylinux1_i686 --universal;
      cd dist;
      zip -d rgf_python-${RGF_VER}-py2.py3-none-manylinux1_i686.whl rgf/rgf;
      mkdir rgf;
      wget https://github.com/fukatani/rgf_python/releases/download/2.1.1/rgf -O rgf/rgf;
      zip rgf_python-${RGF_VER}-py2.py3-none-manylinux1_i686.whl rgf/rgf;
      cd ..;
    fi

deploy:
  file_glob: true
  file: dist/*.whl
  skip_cleanup: true
  draft: true
  provider: releases
  api-key:
    secure: "WGMJ/0VoQ34g1m9k6RkxLOS796HRgK0M8JsVUSs2zW3miwmGGRvh5p8cn+IlOJD0uJyZQksueyN5aEVwUZ5tDuNHb21CDUDupxNjt74EqWAB1fc9Dp72sSWImIPY6PEA/f8OTwQKI00B9WfDJJMPOdlPN57gq7+DlJLsEtWxXssvs/l5JiBc4qO1CwA+y4460cpTrBgB3VnhAF6tju6H4dJtj8lWtXdnFc9gUF/3xTi1QliGrE4doQyLoNOAr4pzNgNjeUjkw9yVKUfa2XsQhyCcLZjBg4Z1t4P15nN/NRaQv/IaYu2WjbRIW1bVadfHUVmuf5F2oRLmR2KrWaJSYTd7wsr+6/Pd/ejZXoL5XJCjCFRxJKHbdL4zIUJa50Auqw6NAwoZSqrLatfsxEjXZaUhaGPg63f44GOA8RSB4X3txPwTXPwXCb8QSq51rfm2zPe6UEvfiVGlyylHtTwP+GKqy1Ml4q+0HPCjne1qufLtNhy+Ke6rD7KgODJi/XElmJwhF8pPCeDp+AmMYbd+Ppid0sISJFCv4IJmAl3FUJ5dtH/wGFUWMQDH8zsF1v94AFXmuO0zvaoOnKOC7P+j3/UXqOUopdC4z0YYqkjJU+OkWO/rnhHhFoWQjys3f1D1q/++yF7wwEu/DkUbxr/29YV2hfa5yH/gHusLmX01d1o="


  on:
    branch: master
    condition: "$PYTHON_VERSION = 3.6"
    tag_name: $TRAVIS_TAG
    tags: true

